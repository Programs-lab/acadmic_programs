<%= render  'shared/card' do %>
  <div class="flex px-4">
    <div class="w-2/3">
    </div>
    <div class="w-1/3 text-right">
    </div>
  </div>
  <div id="schedule_appointments" class="w-full px-4" 
    data-date= "<%= params[:date] || params[:appointment_datetime] || @date %>" 
    data-appointments= "<%= Appointment.where('appointment_datetime >= ? AND state = ?', Date.today, 1).to_json(only: :appointment_datetime) %>" 
    data-patients="<%= User.where(role: :patient, disabled: false).to_json(only: [:first_name, :last_name, :id, :role]) %>"
    data-doctors="<%= User.where(role: :doctor, disabled: false).to_json(only: [:first_name, :last_name, :id, :role]) %>"
    data-doctor="<%= params[:doctor_id] %>" 
    data-patient="<%= params[:patient_id] %>"
    data-appdate="<%= params[:appointment_datetime] %>"
    v-cloak>
    <div class="my-4 flex">
      <div class="w-1/2">
        <h4 class="font-semibold text-g-d4 text-lg">
          <br><span class="font-medium text-g-d2">Historial de citas</span>
        </h3>
      </div>
      <div class="w-1/2 text-right">
        <form class="w-full  justify-end">
          <div class="flex items-center py-2 justify-end">
            
            <div class="flex items-center border-b border-b-2 border-g-l3 w-1/3 ">              
              <datepicker :highlighted="highlighted_dates.highlighted" input-class="w-full flex rounded-t h-8 focus:outline-none" wrapper-class="wrapper" :language="es" v-model="date" placeholder="Fecha..." :calendar-button="true" calendar-button-icon="fas fa-calendar-alt" @input="reload"></datepicker>
            </div>
              <a id="myBtn" @click="modalId('filters')" class="btn btn-secondary mb-1 <%= @search_params.present? ? 'active' : '' %>">
                <%= icon('fa','filter', "v-ripple" => "'rgba(255, 255, 255, 0.20)'")%>
              </a>

              <% if @search_params.present? || (params[:date].present? && Date.parse(params[:date]) != Date.today) %>
                <%= link_to all_appointments_path, method: :get, class: "btn btn-secondary mb-1" do %>
                  <i class="fas fa-undo"></i>
                <% end %>
              <% end %>
          </div>
        </form>
      </div>
    </div>


      <%= form_with url: all_appointments_path, method: :get, local: true, class: "w-full max-w-sm"  do |f|%>

        <modal-vue i= "filters" style_modal="width: 45%;">
          <template v-slot:title>
            Filtros
          </template>
          <template v-slot:content>
            <div class="flex flex-wrap w-full mx-auto" style="width: 86.666%;">
              <div class="w-1/2  mb-6 pr-2 focus_form">
                <%= f.label "Doctor", class: 'label_input'%>
                  <multiselect v-model="doctor" 
                    :options="doctors" 
                    :searchable="true" 
                    :close-on-select="true"  
                    placeholder="Nombre..."  
                    track-by="id" 
                    label= "first_name" 
                    :custom-label="fullName" 
                    select-label=" " 
                    :show-no-results= "false"
                    deselect-label=""
                    selected-label=""
                    @input = "assingDoctorId(doctor)"
                    >
                  </multiselect>
                <%= f.hidden_field :doctor_id,  {"v-model" => "doctor_id"}%>
              </div>
              <div class="w-1/2 mb-6 pl-2 focus_form">
                <%= f.label "Paciente", class: 'label_input' %>
                  <multiselect v-model="patient" 
                    :options="patients" 
                    :searchable="true" 
                    :close-on-select="true"  
                    placeholder="Nombre..."  
                    track-by="id" 
                    label= "first_name" 
                    :custom-label="fullName" 
                    select-label=" " 
                    :show-no-results= "false" 
                    placeholder="Nombre..."
                    deselect-label=""
                    selected-label=""                    
                    @input = "assingPatientId(patient)"
                    >
                  </multiselect>
                <%= f.hidden_field :patient_id,  {"v-model" => "patient_id"} %>
              </div>              
              <div class="flex items-center border-b border-b-2 border-g-l3 w-1/2 ">              
                <datepicker :highlighted="highlighted_dates.highlighted" input-class="w-full flex flex-wrap rounded-t h-8 focus:outline-none" :calendar-button="true" calendar-button-icon="fas fa-calendar-alt" :clear-button="true" :language="es" v-model="appointment_datetime" placeholder="Fecha..." wrapper-class="wrapper"></datepicker>
                <%= f.hidden_field :appointment_datetime,  {"v-model" => "appointment_datetime"} %>
              </div>  
            </div>
          </template>
          <template v-slot:footer>
            <button type="button" name="button" class="btn btn-red-light mx-1" @click="modalId('filters')">Cancelar</button>
            <%= f.submit "Buscar", class: 'btn btn-primary' %>
          </template>
        </modal-vue>

      <% end %>

    <% if @appointments.empty? || @size == 0%>
    <div class="alert alert-info w-full" role="alert">
      <div class="flex">
        <%= icon('fa', 'info-circle', class: 'mr-3 fa-2x') %>
        <div class="text-teal-darkest w-1/2">
          <p class="font-bold">Atenci√≥n.</p>
          <p class="text-sm">No existen citas que cumplan con el criterio</p>
        </div>
      </div>
    </div>
    <% else %>
    <% @appointments.each_with_index do |appointment| %>
    <div class="divider"></div>
    <div class="flex flex-wrap w-full">
      <div class="flex flex-wrap w-full mb-4">
        <h3 class="font-semibold text-grey-darkest text-lg">
          <%= "#{appointment.patient.first_name} #{appointment.patient.last_name}" %>
        </h3>
      </div>
      <div class="flex flex-wrap w-full">
        <div class="flex w-full justify-between">
          <div class="flex w-1/5 mr-2 items-center">
            <%= icon('fas','calendar', class: 'fa-xs mr-1')%>
            {{ $moment("<%= appointment.appointment_datetime %>").format("dddd DD MMMM") }}
          </div>
          <div class="flex w-1/5 ml-2 items-center">
            <%= icon('fas','clock', class: 'fa-xs mr-1')%>
            {{ $moment("<%= appointment.appointment_datetime %>").format("hh:mm a") }}
          </div>
          <div class="flex w-1/5 items-center">
            <%= icon('fas','user-md', class: 'fa-md mr-2')%>
            <p><%= "#{appointment.doctor.first_name} #{appointment.doctor.last_name}"%></p>
          </div>
          <div class="flex w-2/6 justify-center items-center px-8">
            <span class="flex <%= appointment_state(appointment)[1] %> px-2 py-1 mr-3"><%= appointment_state(appointment)[0] %></span>        
          </div>
          <% unless appointment.completed? %>
          <div class="flex w-1/6 justify-end items-center px-8">
            <%= link_to(attend_appointment_path(appointment.id), method: :put, class: "btn btn-secondary no-underline rounded-full:!important #{'disabled' if appointment.appointment_datetime > DateTime.now.end_of_day}") do %>
              <%= icon('fas', 'check-circle', '') %>
            <% end %>
          </div>
          <% else %>  
          <div class="flex w-1/6 justify-end items-center px-8">
            <%= link_to(appointment_summary_path(appointment.id), class: "btn btn-secondary no-underline rounded-full:!important #{'disabled' unless appointment.appointment_report}") do %>
              <%= icon('fas', 'info-circle', '') %>
            <% end %>
          </div>
          <% end %>          
        </div>
      </div>

      <div class="flex flex-wrap w-full mt-4">
        <h3 class="text-grey-darker text-sm">
          Motivo de cita: <%= appointment.procedure_type.procedure_type_name %>
        </h3>
      </div>
    </div>
    <% end %>
    <div class="divider"></div>
  </div>
<% end %>
<% if @search_params.present? %>
  <%== render 'pagy/nav', pagy: @pagy %>
<% else %>
  <div class="flex flex-wrap w-full justify-center">
    <div class="flex flex-wrap w-1/2 justify-end">
    <%= link_to(all_appointments_path(date: @date - 1), method: :get, class: "btn-flat  text-black #{@date.beginning_of_day == DateTime.now.beginning_of_day ? 'disabled' : '' }") do %>
      <%= icon('fas', 'arrow-left', '') %>
    <% end %>
    </div>
    <div class="flex flex-wrap w-1/2">
    <%= link_to(all_appointments_path(date: @date + 1), method: :get, class: "btn-flat text-black") do %>
      <%= icon('fas', 'arrow-right', '') %>
    <% end %>
    </div>
  </div>
<% end %>
  
<% end %>
