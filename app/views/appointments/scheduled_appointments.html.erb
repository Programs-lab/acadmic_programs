<%= render  'shared/card' do %>
  <div class="flex px-4">
    <div class="w-2/3">
    </div>
    <div class="w-1/3 text-right">
    </div>
  </div>
  <div id="schedule_appointments" class="w-full px-4" 
    data-date= "<%= params[:date] || (params[:patient_id].present? && params[:date].blank? ? "" : @date) || @date  %>" 
    data-appointments= "<%= current_user.doctor_appointments.where('appointment_datetime >= ? AND state = ?', Date.today, 1).to_json(only: :appointment_datetime) %>" 
    data-patients="<%= User.where(role: :patient, disabled: false).to_json(only: [:first_name, :last_name, :id, :role]) %>"
    data-doctors="<%= User.where(role: :doctor, disabled: false).to_json(only: [:first_name, :last_name, :id, :role]) %>"
    data-doctor="<%= params[:doctor_id] %>" 
    data-patient="<%= params[:patient_id] %>"
    data-appdate="<%= params[:appointment_datetime] %>"
    v-cloak>
    <div class="my-4 flex">
      <div class="w-1/3">
        <h4 class="font-semibold text-g-d4 text-lg">
          Agenda
          <br><span class="font-medium text-sm text-g-d2">Citas programadas</span>
        </h4>
      </div>
      <div class="w-full text-right">
        <form class="w-full  justify-end">
          <div class="flex items-center py-2 justify-end">
            <%= form_with url: scheduled_appointments_path, method: :get, class: "w-full max-w-sm"  do |f|%>
              <div class="flex items-center border-b border-b-2 border-g-l3 border-r-2 w-1/2 ">              
                <datepicker :highlighted="highlighted_dates.highlighted" input-class="w-full flex rounded-t h-8 focus:outline-none" wrapper-class="wrapper" :language="es" v-model="date" placeholder="Fecha..." :calendar-button="true" calendar-button-icon="fas fa-calendar-alt" :clear-button="true"  @input="reload"></datepicker>
              </div>
               <div class="w-full pt-4 mb-6 border-b focus_form">                
                  <multiselect v-model="patient"
                    id="no-border"
                    :options="patients" 
                    :searchable="true" 
                    :close-on-select="true"  
                    placeholder="Paciente..."  
                    track-by="id" 
                    label= "first_name" 
                    :custom-label="fullName" 
                    select-label=" " 
                    :show-no-results= "false" 
                    placeholder="Nombre..."
                    deselect-label=""
                    selected-label=""                    
                    @input = "assingPatientId(patient)"
                    >
                  </multiselect>
                <%= f.hidden_field :patient_id,  {"v-model" => "patient_id"} %>
              </div> 
               <%= button_tag(type: "submit", class: "btn btn-secondary mb-1") do %>
                    <i class="fas fa-search"></i>
               <% end %>       
              <% if params[:patient_id].present? || (params[:date].present? && Date.parse(params[:date]) != Date.today)%>
                <%= link_to scheduled_appointments_path, method: :get, class: "btn btn-secondary mb-1" do %>
                  <i class="fas fa-undo"></i>
                <% end %>
              <% end %>
            <% end %>
            </div>
          </div>
        </form>
      </div>    
    <% unless @appointments.any? %>
    <div class="alert alert-info w-full" role="alert">
      <div class="flex">
        <%= icon('fa', 'info-circle', class: 'mr-3 fa-2x') %>
        <div class="text-teal-darkest w-1/2">
          <p class="font-bold">Atención.</p>
          <p class="text-sm">No tiene citas programadas para la fecha</p>
        </div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="flex flex-wrap w-full justify-center">
      <div class="flex flex-wrap w-1/2 justify-end">
      <%= link_to(scheduled_appointments_path(date: @date - 1), method: :get, class: "btn-flat  text-black #{@date.beginning_of_day == DateTime.now.beginning_of_day ? 'disabled' : '' }") do %>
        <%= icon('fas', 'arrow-left', '') %>
      <% end %>
      </div>
      <div class="flex flex-wrap w-1/2">
      <%= link_to(scheduled_appointments_path(date: @date + 1), method: :get, class: "btn-flat text-black") do %>
        <%= icon('fas', 'arrow-right', '') %>
      <% end %>
      </div>
    </div>
    <% else %> 
    <% @appointments.each_with_index do |appointment| %>
    <%= render 'info_scheduled_appointment', appointment: appointment %>
    <div class="hidden lg:block xl:block divider"></div>
    <% end %>
    <% if @pagy.pages > 1 %>
      <div class="mt-6"></div>
    <div class="divider"></div>
    <div class="flex flex-wrap w-full">
      <div class="flex flex-wrap w-full mb-4">
        <h3 class="font-semibold text-grey-darkest text-lg">
          <%= "#{appointment.patient.first_name} #{appointment.patient.last_name}" %>
        </h3>
      </div>
      <div class="flex flex-wrap w-full">
        <div class="flex w-2/3 md:w-1/2 justify-between">
          <div class="flex w-3/6 mr-2 items-center">
            <%= icon('fas','calendar', class: 'fa-xs mr-1')%>
            {{ $moment("<%= appointment.appointment_datetime %>").format("dddd DD MMMM") }}
          </div>
          <div class="flex w-2/6 ml-2 items-center">
            <%= icon('fas','clock', class: 'fa-xs mr-1')%>
            {{ $moment("<%= appointment.appointment_datetime %>").format("hh:mm a") }} - {{ $moment("<%= appointment.appointment_datetime + appointment.procedure_type.procedure_duration.minutes %>").format("hh:mm a") }}
          </div>
          <div class="flex w-1/6 pl-8">
            <%= link_to patient_medical_record_path(appointment.patient, appointment), class: 'btn btn-primary mr-1' do %>
              <%= icon('fas','paper-plane', class: 'fa-xs')%>
            <% end %>
            <a id="myBtn" @click="modalId('cancel')" class='btn btn-red-light'>
              <%= icon('fas','ban', "v-ripple" => "'rgba(255, 255, 255, 0.20)'")%>
            </a>
          </div>
        </div>
      </div>


        <%= form_with url: cancel_appointment_path(appointment_id: appointment.id), method: :put, local: true do |form|%>

          <modal-vue i= "cancel" style_modal="width: 45%;">
            <template v-slot:title>
              Cancelar cita
            </template>
            <template v-slot:content>
              <div class="flex flex-wrap mx-auto" style="width: 86.666%;">
                <div class="flex w-full">
                  <p>¿Esta seguro de que desea cancelar esta cita? Esta accion es irreversible</p>
                </div>
                <br>
                <br>
                <div class="w-full mb-6 focus_form">
                  <%= form.label "Razon de cancelacion (recomendado)", class: 'label_input' %>
                  <%= form.text_area :reason, class: 'simple-content' %>
                </div>
                <div>
                  <%= form.hidden_field :current_user_id, value: current_user.id %>
                </div>
              </div>
            </template>
            <template v-slot:footer>
              <button type="button" name="button" class="btn btn-red-light mx-1" @click="modalId('cancel')">Cancelar</button>
              <%= form.submit "Acceptar", class: 'btn btn-primary' %>
            </template>
          </modal-vue>

      <% end %>

      <div class="flex flex-wrap w-full mt-4">
        <h3 class="text-grey-darker text-sm">
          Motivo de cita: <%= appointment.procedure_type.procedure_type_name %>
        </h3>
      </div>
    </div>
    <% end %>
  </div>
<% if params[:patient_id].present? %>
  <%== render 'pagy/nav', pagy: @pagy %>
<% else %>
  <div class="flex flex-wrap w-full justify-center">
    <div class="flex flex-wrap w-1/2 justify-end">
    <%= link_to(scheduled_appointments_path(date: @date - 1), method: :get, class: "btn-flat  text-black #{@date.beginning_of_day == DateTime.now.beginning_of_day ? 'disabled' : '' }") do %>
      <%= icon('fas', 'arrow-left', '') %>
    <% end %>
    </div>
    <div class="flex flex-wrap w-1/2">
    <%= link_to(scheduled_appointments_path(date: @date + 1), method: :get, class: "btn-flat text-black") do %>
      <%= icon('fas', 'arrow-right', '') %>
    <% end %>
    </div>
  </div>
  </div>
<% end %>
<% end %>
<% end %>
